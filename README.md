# Диалоговый бот-консультант по учебным планам ИТМО (AI / AI Product)

Бот отвечает **только** на вопросы по содержимому двух магистерских программ ИТМО — «AI» и «AI Product»: обязательные/выборные дисциплины, треки/траектории, семестры, нагрузка, пререквизиты и пересечения курсов. Встроен фильтр релевантности: оффтоп отклоняется, релевантные вопросы получают ответ + рекомендации.

---

## Инструментарий и стек

* Извлечение текста из планов: PyMuPDF (приоритет) / PyPDF (fallback).
* Векторизация текста: OpenAI Embeddings.
* Генерация ответов и «гейт» релевантности: модели семейства GPT-4o..
* Конфигурация через переменные окружения (API-ключ, модели, базовый URL при использовании прокси).

---

## Что сделано по пунктам задания

### 1) Парсинг сайтов/планов

* Учебные планы предоставлены в PDF.
* Выполнено извлечение текста в два файла: `ai.txt` и `ai_product.txt`.
* Проведена лёгкая очистка (убраны лишние пробелы/переводы строк), чтобы снизить «шум» из таблиц и колонок.

**Почему так:** PDF часто «шумные», поэтому нужен простой и устойчивый пайплайн PDF→TXT, сохраняющий смысловые блоки (обязательные/выборные дисциплины, семестры, треки).

---

### 2) Диалоговая система с ответами по содержимому

* Реализован чат-контур: пользователь задаёт вопрос → система ищет релевантные фрагменты в подготовленных TXT → модель формирует ответ, опираясь **исключительно** на найденный контекст.
* Роль system жёстко ограничивает знания бота двумя источниками и тематикой учебных планов.
* В ответ включаются только факты, найденные в текстах; при отсутствии данных — честное сообщение, что в источниках этого нет.



---

### 3) Рекомендации (при релевантном вопросе)

* Формат ответа фиксирован:

  1. короткий фактологичный ответ по существу;
  2. **рекомендации** по элективам/траектории (3–6 пунктов) с указанием программы/семестров/треков;
  3. мини-план по семестрам — если вопрос о планировании.
* Если у пользователя мало вводных, бот сначала просит 2–3 уточнения (фон/интересы/цели), но сразу даёт «базовый старт» (например, фундаментальные курсы + один профильный трек).

**Почему так:** пункт задания требует практичности и привязки к учебному плану — рекомендации встроены в обязательный формат ответа.

---

### 4) Анализ релевантности вопросов (фильтр)

Реализован многоступенчатый фильтр:

1. **Разбиение на куски**: корпус планов делится на фрагменты \~900 символов с перекрытием 150. Это повышает точность попадания в нужные разделы.
2. **Гибридный ретривал**: итоговый скор — это взвешенная сумма
   • косинусной близости эмбеддингов (семантика) и
   • пересечения по ключевым словам без стоп-слов (лексическое совпадение).
   Вес семантики выше, но не абсолютный.
3. **Мягкий порог релевантности**: настроен так, чтобы не «рубить» пограничные случаи (PDF-шум часто занижает косинус).
4. **LLM-гейт**: если топ-скор чуть ниже порога, маломодельный классификатор отвечает «да/нет» на вопрос «по теме ли это двух программ». При «да» — вопрос допускается.

**Почему так:** чистая семантика по шумным PDF даёт много ложных «нерелевантно». Гибрид + мягкий порог + гейт устраняют это.

---

## Архитектура решения (по шагам)

1. **Подготовка данных:** конвертация двух PDF в TXT; очистка текста.
2. **Индексирование:** разбиение TXT на перекрывающиеся фрагменты; вычисление эмбеддингов для каждого фрагмента.
3. **Обработка запроса:** эмбеддинг запроса; расчёт гибридного скора фрагментов; выбор top-K.
4. **Фильтр релевантности:** сравнение top-1 с порогом; при сомнении — LLM-гейт.
5. **Формирование ответа:** роль system ограничивает домен; в подсказку модели подмешиваются лучшие фрагменты; ответ строится строго по формату (факт → рекомендации → мини-план).
6. **Отказ от оффтопа:** при нерелевантности выдается вежливое пояснение и примеры корректной формулировки.

---

## Формат взаимодействия и роли

* **System:** «Отвечай только по двум программам (AI и AI Product) и только на основе предоставленных файлов. Если в источниках нет — сообщи об этом. При релевантности всегда добавляй рекомендации и мини-план при необходимости».
* **User:** задаёт вопрос про дисциплины, треки, семестры, нагрузку, пререквизиты, пересечения; допускается указывать свой фон/цели.
* **Bot:** краткий факт → 3–6 рекомендаций с привязкой к программе/семестрам → мини-план при запросе планирования; при недостатке вводных — короткие уточнения + базовая рекомендация.

---

## Примеры корректных и некорректных вопросов

* Релевантные:
  • «Какие выборные дисциплины по NLP доступны в AI Product и когда их лучше брать?»
  • «Можно ли совмещать трек по CV и курс по MLOps в AI? Как распределить по семестрам?»
  • «Где больше математики: в AI или AI Product? Какие обязательные курсы пересекаются?»

* Нерелевантные:
  • «Сколько платят джуниорам DS в Петербурге?»
  • «Сравните ИТМО и МФТИ по магистратурам».
  • «Как поступить в другой вуз/на другую программу?»

---

## Конфигурация и эксплуатационные заметки

* Ключи и параметры задаются через переменные окружения (API-ключ, базовый URL прокси, имена моделей).
* Пути к текстовым файлам должны быть корректными; на Windows избегать неэкранированных обратных слэшей и обязательно заключать пути с пробелами в кавычки.
* Для диагностики предусмотрен краткий «баннер версии» и отладочный вывод top-скоров и источников фрагментов.

---

## Как принимались решения

* **RAG вместо «сырых» ответов модели:** чтобы ответы опирались на планы, а не на общие знания.
* **Гибридный ретривал:** компенсирует шум из PDF и повышает recall по терминам (NLP, MLOps, CV, семестр N, элективы).
* **Мягкий порог + LLM-гейт:** баланс precision/recall, снижение ложных отказов на пограничных запросах.
* **Жёсткая роль system:** чтобы не уходить за рамки предметной области и покрыть требования задания.

---

## Ограничения и риски

* Качество извлечения текста из PDF зависит от верстки исходников; таблицы и многоколонник могут вносить шум.
* При пустых или обрезанных разделах в TXT часть ответов будет невозможна (бот честно сообщает, что данных нет).
* Неверная конфигурация (несуществующие пути, неподдерживаемые модели, невалидный ключ/прокси) приводит к отказам на этапе индексации или генерации.

---

## Отладка (типичные симптомы)

* «Всегда нерелевантно»: снизить порог релевантности, проверить наполнение TXT, убедиться в корректной векторизации.
* «Unicode-ошибки путей на Windows»: использовать прямые слэши или «сырые» строки; пути с пробелами — в кавычки.
* «Нет ответа модели»: проверить API-ключ, базовый URL, поддерживаемость выбранных моделей прокси-ендпоинтом.

---

## Идеи для развития

* Привязка фрагментов к страницам PDF и выдача точных ссылок/якорей.
* Поддержка нескольких программ/версий планов с автоопределением по вопросу.
* Панель настроек порогов и параметров ретрива; кэширование эмбеддингов.
* Telegram-обёртка и веб-панель для удобного доступа.

---

## Вывод

Решение реализует полный цикл: от извлечения данных из планов до диалоговой системы с жёсткой доменной изоляцией, гибридным ретривалом и практическими рекомендациями. Такой дизайн удовлетворяет всем пунктам задания: парсинг, ответы по содержимому, рекомендации и проверка релевантности запросов.
